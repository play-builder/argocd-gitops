# =============================================================================
# Kustomize Build Validation
# =============================================================================
# PRì—ì„œ Kustomize ë§¤ë‹ˆíŽ˜ìŠ¤íŠ¸ê°€ ì˜¬ë°”ë¥´ê²Œ ë¹Œë“œë˜ëŠ”ì§€ ê²€ì¦í•©ë‹ˆë‹¤.
# ë¬¸ë²• ì˜¤ë¥˜, íŒ¨ì¹˜ ëˆ„ë½, ë¦¬ì†ŒìŠ¤ ì°¸ì¡° ì˜¤ë¥˜ ë“±ì„ ì‚¬ì „ì— ë°œê²¬í•©ë‹ˆë‹¤.
# =============================================================================
name: Validate Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - "kustomize/**"
      - "argocd/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: ðŸ” Kustomize Build Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        overlay: [dev, prod]
    steps:
      - uses: actions/checkout@v5

      # kustomize ì„¤ì¹˜
      - name: ðŸ“¦ Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.4.3"

      # kustomize build ê²€ì¦
      - name: ðŸ—ï¸ Kustomize Build (${{ matrix.overlay }})
        id: build
        run: |
          echo "### Building kustomize/overlays/${{ matrix.overlay }}..."
          kustomize build kustomize/overlays/${{ matrix.overlay }} > /tmp/manifests.yaml
          echo "âœ… Build successful"
          echo "---"
          echo "Generated $(wc -l < /tmp/manifests.yaml) lines of YAML"

      # YAML ë¬¸ë²• ê²€ì¦
      - name: ðŸ“ YAML Lint
        run: |
          pip install yamllint --break-system-packages
          yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}}}" \
            kustomize/overlays/${{ matrix.overlay }}/

      # (ì„ íƒ) kubevalë¡œ K8s API ìŠ¤í‚¤ë§ˆ ê²€ì¦
      - name: âœ… Validate K8s Manifests
        run: |
          # kubeval ì—†ì´ë„ kustomize build ì„±ê³µì´ë©´ ê¸°ë³¸ ê²€ì¦ ì™„ë£Œ
          echo "Kustomize build passed for ${{ matrix.overlay }} overlay"

      - name: ðŸ’¬ Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### âŒ Kustomize Build Failed â€” ${{ matrix.overlay }}\n\nPlease check the build output for errors.`
            });