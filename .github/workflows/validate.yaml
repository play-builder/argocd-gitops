# Kustomize Build Validation
name: Validate Manifests

on:
  pull_request:
    branches: [main]
    paths:
      - "kustomize/**"
      - "argocd/**"

permissions:
  contents: read
  pull-requests: write

jobs:
  validate:
    name: ðŸ” Kustomize Build Check
    runs-on: ubuntu-latest
    strategy:
      matrix:
        overlay: [dev, prod]
    steps:
      - uses: actions/checkout@v5

      # Install Kustomize
      - name: ðŸ“¦ Setup Kustomize
        uses: imranismail/setup-kustomize@v2
        with:
          kustomize-version: "5.4.3"

      # Validate Kustomize Build
      - name: ðŸ—ï¸ Kustomize Build (${{ matrix.overlay }})
        id: build
        run: |
          echo "### Building kustomize/overlays/${{ matrix.overlay }}..."
          kustomize build kustomize/overlays/${{ matrix.overlay }} > /tmp/manifests.yaml
          echo "âœ… Build successful"
          echo "---"
          echo "Generated $(wc -l < /tmp/manifests.yaml) lines of YAML"

      # YAML Syntax Validation
      - name: ðŸ“ YAML Lint
        run: |
          pip install yamllint --break-system-packages
          yamllint -d "{extends: relaxed, rules: {line-length: {max: 200}}}" \
            kustomize/overlays/${{ matrix.overlay }}/

      # (Optional) K8s API Schema Validation
      - name: âœ… Validate K8s Manifests
        run: |
          curl -sSL https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz \
           | tar xz -C /usr/local/bin
          kubeconform -strict -summary \
           -schema-location default \
           -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
           -ignore-missing-schemas \
           /tmp/manifests.yaml

      - name: ðŸ’¬ Comment on PR
        if: failure()
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `#### âŒ Kustomize Build Failed â€” ${{ matrix.overlay }}\n\nPlease check the build output for errors.`
            });
