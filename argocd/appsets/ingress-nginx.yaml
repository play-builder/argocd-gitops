apiVersion: argoproj.io/v1alpha1
kind: ApplicationSet
metadata:
  name: ingress-nginx
  namespace: argocd
  labels:
    app.kubernetes.io/name: ingress-nginx
    app.kubernetes.io/component: addon
    app.kubernetes.io/part-of: exchange-settlement
spec:
  goTemplate: true
  goTemplateOptions: ["missingkey=error"]
  generators:
    - git:
        repoURL: https://github.com/play-builder/argocd-gitops.git
        revision: main
        files:
          - path: "argocd/appsets/envs/*.json"
  template:
    metadata:
      name: "ingress-nginx-{{ .env }}"
      namespace: argocd
      labels:
        app.kubernetes.io/name: ingress-nginx
        app.kubernetes.io/component: addon
        app.kubernetes.io/part-of: exchange-settlement
        environment: "{{ .env }}"
      annotations:
        argocd.argoproj.io/sync-wave: "2"
      finalizers:
        - resources-finalizer.argocd.argoproj.io
    spec:
      project: "{{ .project }}"
      source:
        repoURL: https://kubernetes.github.io/ingress-nginx
        chart: ingress-nginx
        targetRevision: "{{ .ingressNginxVersion }}"
        helm:
          releaseName: ingress-nginx
          values: |
            controller:
              allowSnippetAnnotations: false
              replicaCount: {{ .ingressNginxReplicas }}
              # Security headers - Helm auto-creates ConfigMap from this block
              # Replaces both configuration-snippet and config.add-headers approaches
              addHeaders:
                Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
                X-Frame-Options: "DENY"
                X-Content-Type-Options: "nosniff"
                X-XSS-Protection: "0"
                Referrer-Policy: "strict-origin-when-cross-origin"
                Permissions-Policy: "camera=(), microphone=(), geolocation=()"
              service:
                type: LoadBalancer
                annotations:
                  service.beta.kubernetes.io/aws-load-balancer-type: nlb
                  service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
                  service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
              resources:
                requests:
                  cpu: "{{ .ingressNginxCpuReq }}"
                  memory: "{{ .ingressNginxMemReq }}"
                limits:
                  cpu: "{{ .ingressNginxCpuLim }}"
                  memory: "{{ .ingressNginxMemLim }}"
              metrics:
                enabled: true
      destination:
        server: https://kubernetes.default.svc
        namespace: ingress-nginx
      syncPolicy:
        automated:
          prune: true
          selfHeal: true
        syncOptions:
          - CreateNamespace=true
        retry:
          limit: "{{ .retryLimit }}"
          backoff:
            duration: "{{ .retryDuration }}"
            factor: 2
            maxDuration: "{{ .retryMaxDuration }}"
  # Prod-only: topologySpreadConstraints for HA across AZs
  templatePatch: |
    {{- if eq .env "prod" }}
    spec:
      source:
        helm:
          values: |
            controller:
              allowSnippetAnnotations: false
              replicaCount: {{ .ingressNginxReplicas }}
              addHeaders:
                Strict-Transport-Security: "max-age=31536000; includeSubDomains; preload"
                X-Frame-Options: "DENY"
                X-Content-Type-Options: "nosniff"
                X-XSS-Protection: "0"
                Referrer-Policy: "strict-origin-when-cross-origin"
                Permissions-Policy: "camera=(), microphone=(), geolocation=()"
              service:
                type: LoadBalancer
                annotations:
                  service.beta.kubernetes.io/aws-load-balancer-type: nlb
                  service.beta.kubernetes.io/aws-load-balancer-scheme: internet-facing
                  service.beta.kubernetes.io/aws-load-balancer-nlb-target-type: ip
              resources:
                requests:
                  cpu: "{{ .ingressNginxCpuReq }}"
                  memory: "{{ .ingressNginxMemReq }}"
                limits:
                  cpu: "{{ .ingressNginxCpuLim }}"
                  memory: "{{ .ingressNginxMemLim }}"
              metrics:
                enabled: true
              topologySpreadConstraints:
                - maxSkew: 1
                  topologyKey: topology.kubernetes.io/zone
                  whenUnsatisfiable: DoNotSchedule
                  labelSelector:
                    matchLabels:
                      app.kubernetes.io/name: ingress-nginx
                      app.kubernetes.io/component: controller
    {{- end }}
